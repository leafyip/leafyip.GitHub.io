---
title: 如何保证接口的幂等性
date: 2020-12-11 22:16:36
tags: 分布式
---
接口幂等性是指 同一个接口被调用一次和被调用多次 处理的结果是一致的.

对于select和delete操作.从数据的角度来说,多次调用也是幂等的.

对于insert和update操作,幂等性接口设计有如下方案

## (1) token机制
服务器生成token,保存在redis里,并将token返回给客户端.
客户端携带token 调用幂等性接口,幂等接口删除token,再处理业务逻辑.


## (2) 乐观锁机制
更新操作中,在表添加版本号 `version` 字段.
先select 获取当前数据的版本号,update 时带上版本号.

## (3)记录数据状态
要更新的数据行添加状态,如status 0 待支付,1未支付,2支付成功,3支付失败
更新数据的时候带上状态
如 `update table set column='xxx' where status = 0`

## (4) 唯一索引
可根据业务在数据表建立唯一索引.为防止频繁访问数据库,这个唯一索引的值可也先放在redis中过滤.