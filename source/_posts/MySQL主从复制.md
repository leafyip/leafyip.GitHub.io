---
title: MySQL主从复制
date: 2020-10-05 18:54:07
tags: mysql
---

# 1 MySQL主从复制原理

MySQL支持将数据从一台服务器复制到另一台或多台.一台住库的数据可以同步到多台备库,备库自身也可以配置成另外一台服务器的主库.
MySQL支持两种复制方式:
基于 语句 的复制
基于 行 的复制(5.1版本后才支持)

复制过程
1. 主库将修改的记录写入到二进制日志(bin log)中
2. 备库新建一个IO线程,连接主库.
主库启动一个特殊的二进制转储(binlog dump)线程,该线程将二进制内容发送到备库,如果binlog dump线程追赶上了主库,即已经将主库所有二进制日志都发送给备库,它会进入休眠,直到主库有新的记录写入到二进制日志中才会被唤醒.
备库IO线程将接收到的事件记录到中继日志中
3. 备库SQL线程从中继日志中读取事件并执行

<!--more-->
![Alt text](/images/mysql_master_slave_copy.png)

# 2 主从复制优点
+ 备份恢复,主库故障可使用备库提供服务.
+ 读写分离


# 3 主从复制缺点及解决方案

## 3.1 数据丢失以及半同步复制

5.5版本之前,主库与备库之间的数据复制是异步的,5.5版本后,MySQL添加了半同步复制semi-sync.
+ 异步复制: 客户端提交事务,主库写入数据到binlog后返回成功给客户端,主库不会理会备库的同步进度.
当主库的进度大于备库的进度,主库宕机后,备库会丢失一部分数据

+ 半同步复制: 客户端提交事务,主库写入数据到binlog,并等待备库接收日志后(不需要等待备库SQL线程)才返回成功给客户端.
本同步复制可以保证数据都写入到备库的中继日志

如图
![Alt text](/images/mysql_semi_sync.png)

semi-sync并不是100%保证数据不丢失,当主库存储引擎提交事务后,并在发送日志给备库的时候宕机,此时备库仍然会丢失数据.

主库网络故障,或者备库挂了,主库在事务提交后等待一定的时间(rpl_semi_sync_master_timeout)后,主库会变回原来的异步复制状态.

## 3.2 主从延时以及并行复制
由于备库从主库拉取日志并成功执行需要一定的时间,这段时间内,主库和备库的数据不一致,有延迟.
当主库的TPS并发较高时,备库SQL线程(5.5即之前的版本都是单线程的)执行的速度跟不上主库数据更改的速度,主从延时会越来越大.

减少主从延时的方式有
一 主库和备库保持良好的传输网络
二 备库开启多个SQL线程来执行中继日志.
三 降低主库的TPS,分库.

并行复制 是指备库开启多个SQL线程,并行读取relay log的日志,然后写入到数据库

+ MySQL 5.6 开始支持基于库(schema)的并行复制,5.6仅支持基于库级别的并行复制
+ MySQL 5.7 开始支持基于组(group)的并行复制
+ MySQL8.0 开始支持基于writeset的并行复制