---
title: mysql并发多版本控制
date: 2020-09-24 20:07:33
tags: mysql
---

mysql多版本并发控制(MVVC)
不同数据库实现MVVC机制各有不同。
mysql不同存储引擎实现MVVC也不尽相同，典型的实现方式有乐观锁和悲观锁。
InnoDB 存储引擎是基于乐观锁实现的
以下讨论 InnoDB 默认隔离级别（repeatable-read）的多版本并发控制

InnoDB是通过在表里添加两个隐藏的列来实现的。每一行数据都额外维护了创建时间，删除时间两个隐藏列。这两列保存的并不是时间戳，而是事务的版本号。
每个事务的创建，版本号都是递增的。
<!--more-->

对于select操作，只会取同时符合以下条件的数据
（1） 数据的事务版本号小于等于当前事务版本
（2） 数据的删除版本号为 未定义 ， 或者大于当前事务版本号。


insert 操作
	新增一条记录,然后用当前事务版本号作为 行版本号

delete 操作
	数据的删除版本号 设置为当前事务版本号
	
update 操作
insert + delete 的结合.
先插入新的一行,当前事务版本号为行版本号.
然后旧数据的删除版本号设置为当前事务版本号

	
MVCC只在已提交读(read-commited)和可重复读(repeatable-read)的隔离级别下工作.
因为读未提交(read-uncommited)总是读取最新的行,而不是符合当前事务的行.
串行化(serializable)只允许一个事务同时运行
