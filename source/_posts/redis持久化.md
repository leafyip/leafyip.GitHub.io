---
title: redis持久化
date: 2020-09-14 20:08:04
tags: redis
---

# redis持久化策略

redis官方持久化方式有两种

- 快照(RDB) : 保存了redis某个时间点的数据集

- 追加文件(AOF) : 记录redis执行的所有操作命令,并在服务器启动时,通过执行这些命令来还原数据

## 1 快照(RDB)
优点 
	1. 通过合理配置,可以很方便地讲数据还原到某个特定的时间.
	2. RDB文件比AOF文件占用的空间小,且恢复数据的速度也更快
	3. 如果创建RDB文件时出现错误,不会影响到之前保存的版本.

缺点
	a 会丢失未来得及生成快照的数据
	b fork子进程占用的内存会随着数据的增加而增加,恢复时间也会相应增加.
<!--more-->


## 2 追加文件(AOF)
优点:
-数据完整性更高（最多丢失1秒的数据）
-该机制对日志文件是追加的，即使追加过程中系统宕机，也不会影响之前已经存在的内容。
-

缺点:
-相同数据集，AOF文件比RDB大，恢复速度也慢

-根据同步策略不同，AOF在运行效率下会低于RDB
AOF持久化功能可以分为命令追加,文件写入和文件同步.



-命令追加: 当AOF开启时,redis执行完一个命令后,会以协议格式将被执行的写命令追加到服务器的aof_buf缓冲区的末尾


[^_^]: #-写入和同步 : 每当服务器常规任务函数被执行、 或者事件处理器被执行时， aof.c/flushAppendOnlyFile 函数都会被调用， 这个函数执行以下两个工作：
	WRITE：根据条件，将 aof_buf 中的缓存写入到 AOF 文件。
	SAVE：根据条件，调用 fsync 或 fdatasync 函数，将 AOF 文件保存到磁盘中。

这两个步骤都根据设置的保存模式来执行

*/
Redis 目前支持三种 AOF 保存模式，它们分别是：

AOF_FSYNC_NO ：不保存。

AOF_FSYNC_EVERYSEC ：每一秒钟保存一次。

AOF_FSYNC_ALWAYS ：每执行一个命令保存一次。

## 1 不保存 
	在这种模式下， 每次调用 flushAppendOnlyFile 函数， WRITE 都会被执行， 但 SAVE 会被略过。

	SAVE 只会在以下任意一种情况中被执行：

-Redis 被关闭
-AOF 功能被关闭
-系统的写缓存被刷新（可能是缓存已经被写满，或者定期保存操作被执行）

## 2 每一秒保存
	此时save操作是由后台子进程调用，不会影响主线程。原则上每秒执行调用sync和syncdata。
每当flushAppendOnlyFile函数被调用，会有以下四中情况。
- 子线程正在执行save
  1.save执行时间未超过2秒，程序直接返回，不执行write和save
  2.save执行时间超过2秒，程序阻塞等待旧save的执行完成后再执行write，但不执行save。
  
-子线程没有执行save
  3.距离上次执行save已经超过1秒，执行write和save
  4.距离上次执行save成功未超过1秒，执行write，不执行save。

![Alt text](/images/redis_save_per_second.png)


这种模式最多会丢失2秒的数据。

## 3 每执行一个命令保存一次
	这种模式下，每个命令执行完write和save都会被调用，由于是主线程执行save操作，save执行期间，主线程阻塞，不能接受客户端的命令。

